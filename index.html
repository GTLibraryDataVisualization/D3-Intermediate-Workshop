<!DOCTYPE html>
<html>
<head>
	<title>Georgia Tech 2016 Crime Map</title>
	<!-- import D3 and Leaflet -->
	<script src="https://d3js.org/d3.v4.min.js"></script>
	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.3/dist/leaflet.css" />
	<link rel="stylesheet" type="text/css" href="stylesheet.css" />
	<script src="https://unpkg.com/leaflet@1.0.3/dist/leaflet.js"> </script>
</head>

<body>
	<div id="container">
	 <div id="header">
	 </div>
	 <div id="content_area">
		<div id="left_col">
		</div>
		<div id="right_col">
		 <div id="mapid"></div>
	 	</div>
	 </div>
		<div id="footer">
		</div>
	</div>
</body>

	<script type="text/javascript">
		//set coordinates to GT's student center
		var atl = new L.LatLng(33.77487566, -84.39795059);
		//create map object with GT's student center at the center of map
		var mymap = L.map('mapid').setView(atl, 16);
		L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}', {
				attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://mapbox.com">Mapbox</a>',
				maxZoom: 17,
				minZoom: 15,
				id: 'mapbox.light',
				accessToken: 'pk.eyJ1IjoiamFnb2R3aW4iLCJhIjoiY2lnOGQxaDhiMDZzMXZkbHYzZmN4ZzdsYiJ9.Uwh_L37P-qUoeC-MBSDteA'
		}).addTo(mymap);

		//svg layer on top of the map object to write data points
		var svgLayer = L.svg();
		svgLayer.addTo(mymap)

		var svg = d3.select("#mapid").select("svg");
		var selectBar = d3.select("#left_col").append("select");
		var listview = d3.select("#left_col").append("ul");

		var g = svg.select("g");
		g.attr("class", "leaflet-zoom-hide");

		selectBar.attr("id", "category-selector")
			.on("change", changeList);

	  var optionsArr = [ {'value': "Earliest Cases"}, {'value': "Latest Cases"}, {'value': "Cases: Closed/Cleared"}, {'value': "Cases: Closed/Leads Exhausted"}, {'value': "Cases: Further Investigation"}, {'value': "Cases: Inactive"}];
	  var options = selectBar.selectAll("option")
	                 .data(optionsArr)
	                 .enter()
	                 .append("option")
									 .text(function (d) { return d.value; })
									 .attr("id", function (d) { return d.value; });

		var nodesData;
		//load in the data from crime_log.csv
		d3.csv('/crime_log.csv', function(error, nodes) {
			if(error)
					console.log(error)

			nodesData = nodes;
			listview.selectAll("li")
				.data(nodes).enter()
				.filter(function(d) { return (d.CaseStatus !== "" && d.LocationLatitude !== "" && d.LocationLongitude !== "") })
				.append("li")
				.attr("id", function(d) {
						return d["OCANumber"];
				})
				.style("background", function(d) {
					if (d.CaseStatus === "Closed/Cleared") {
						return "#83E843"; //green
					} else if (d.CaseStatus === "Closed/Leads Exhausted") {
						return "#E8D2E8"; //grey
					} else if (d.CaseStatus === "Further Investigation") {
						return "#FFD365"; //orange
					} else if (d.CaseStatus === "Inactive") {
						return "#76B4E8"; //blue
					}
				})
				.html(function(d) {
					var CaseStatus = d["CaseStatus"];
					var CaseDisposition = d["CaseDisposition"];
					var Offense_Description = d["Offense Description"];
					var IncidentFromDate = d["IncidentFromDate"];
					var IncidentToDate = d["IncidentToDate"];
					var IncidentFromTime = d["IncidentFromTime"];
					var IncidentToTime = d["IncidentToTime"];
					var LocationLandmark = d["LocationLandmark"];
					var LocationStreet = d["LocationStreet"];
					var LocationLatitude = d["LocationLatitude"];
					var LocationLongitude = d["LocationLongitude"];
					return  "CaseStatus: " + CaseStatus + "<br />" +
									"Offense Description: " + Offense_Description + "<br />" +
									"CaseDisposition: " + CaseDisposition + "<br />" +
									"IncidentFromTime: " + IncidentFromTime + "<br />" +
									"IncidentToTime: " + IncidentToTime + "<br />" +
									"IncidentFromDate: " + IncidentFromDate + "<br />" +
									"IncidentToDate: " + IncidentToDate + "<br />" +
									"LocationLandmark: " + LocationLandmark + "<br />" +
									"LocationStreet: " + LocationStreet + "<br />" +
									"LocationLatitude: " + LocationLatitude + "<br />" +
									"LocationLongitude: " + LocationLongitude;
				});

			//creating the circle dots from the data in crime_log.csv
			g.selectAll('circle')
					.data(nodes)
					.enter().append('circle')
							.style("opacity", 0.3)
							.style("fill", 'red')
							.attr('r', 6);


			//setting the location of the circle dots from the data in crime_log.csv
			nodes.forEach(function(d){
					d.LatLng = [+d.LocationLatitude, +d.LocationLongitude];
			})

			mymap.on('zoomend', updateNodes);

			updateNodes();
		})

		function updateNodes(){
		    g.selectAll('circle')
		        .attr('cx', function(d){return mymap.latLngToLayerPoint(d.LatLng).x})
		        .attr('cy', function(d){return mymap.latLngToLayerPoint(d.LatLng).y})
		}
		//TO DO: List view filtering update based on selection of select bar
		function changeList() {
			var selectedValue = d3.select('select').property('value');
			if (selectedValue === "Earliest Cases") {
				var newNodes = nodesData.sort(function(a, b) {
						var dateA = new Date(a.IncidentFromDate), dateB = new Date(b.IncidentFromDate);
						return dateA - dateB;
				});
				console.log(newNodes);
				// listview.selectAll("li")
				// 	.data(newNodes).enter();
			} else if (selectedValue === "Latest Cases") {
				var newNodes = nodesData.sort(function(a, b) {
						var dateA = new Date(a.IncidentFromDate), dateB = new Date(b.IncidentFromDate);
						return dateB - dateA;
				});
				console.log(newNodes);
				// listview.selectAll("li")
				// 	.data(newNodes).enter();
			} else if (selectedValue === "Cases: Closed/Cleared") {
					var nested_data = d3.nest()
					.key(function(d) { return d.CaseStatus })
					// .key(function(d) { return d.CaseStatus === "Cases: Closed/Cleared"; })
					.entries(nodesData);
					console.log(nested_data);
					// listview.selectAll("li")
					// 	.data(newNodes).enter();
				} else if (selectedValue === "Cases: Closed/Leads Exhausted") {
					var nested_data = d3.nest()
					.key(function(d) { return d.CaseStatus === "Cases: Closed/Leads Exhausted"; }).sortKeys(d3.ascending)
					// .key(function(d) { return d.CaseStatus === "Cases: Closed/Leads Exhausted"; })
					.entries(nodesData);
					console.log(nested_data);
					// listview.selectAll("li")
					// 	.data(newNodes).enter();
					}
		}

	</script>

</html>
